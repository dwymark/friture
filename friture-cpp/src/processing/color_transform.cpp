/**
 * @file color_transform.cpp
 * @brief Implementation of ColorTransform
 *
 * @author Friture C++ Port
 * @date 2025-11-06
 */

#include <friture/color_transform.hpp>

namespace friture {

// ============================================================================
// CMRMAP Data - 256 RGB triplets from Friture Python implementation
// ============================================================================
// Reference: Rappaport, C. 2002: "A Color Map for Effective Black-and-White
// Rendering of Color Scale Images", IEEE Antenna's and Propagation Magazine

// CMRMAP data - 256 RGB triplets
// Generated from Friture's plotting/generated_cmrmap.py
// Black → Purple → Red → Yellow → White
static const float CMRMAP_DATA[256][3] = {
    {0.002180479851076918f, 0.002180479851076913f, 0.002180479851076917f},
    {0.003087188286726274f, 0.006955171701011791f, 0.008284688607875967f},
    {0.004156686898368900f, 0.011592087289586628f, 0.014863182110308133f},
    {0.005386845223313601f, 0.016094117959025180f, 0.021899027862313996f},
    {0.006775532798869182f, 0.020464155051551216f, 0.029375293367834145f},
    {0.008320619162344446f, 0.024705089909388512f, 0.037275046130809175f},
    {0.010019973851048204f, 0.028819813874760812f, 0.045581353655179638f},
    {0.011871466402289256f, 0.032811218289891898f, 0.054277283444886158f},
    {0.013872966353376407f, 0.036682194497005528f, 0.063345903003869289f},
    {0.016022343241618466f, 0.040435633838325463f, 0.072770279836069651f},
    {0.018317466604324234f, 0.044074427656075478f, 0.082533481445427812f},
    {0.020756205978802511f, 0.047601467292479313f, 0.092618575335884357f},
    {0.023336430902362117f, 0.051019644089760764f, 0.103008629011379846f},
    {0.026056010912311849f, 0.054331849390143579f, 0.113686709975854908f},
    {0.028912815545960507f, 0.057540974535851518f, 0.124635885733250101f},
    {0.031904714340616896f, 0.060649910869108356f, 0.135839223787506014f},
    {0.035029576833589843f, 0.063661549732137848f, 0.147279791642563246f},
    {0.038285272562188125f, 0.066578782467163811f, 0.158940656802362384f},
    {0.041669671063720555f, 0.069404500416409914f, 0.170804886770844017f},
    {0.045180641875495947f, 0.072141594922099955f, 0.182855549051948646f},
    {0.048816054534823100f, 0.074792957326457743f, 0.195075711149616970f},
    {0.052573778579010820f, 0.077361478971707032f, 0.207448440567789522f},
    {0.056451683545367899f, 0.079850051200071534f, 0.219956804810406858f},
    {0.060447638971203164f, 0.082261565353775060f, 0.232583871381409651f},
    {0.064559514393825429f, 0.084598912775041377f, 0.245312707784738460f},
    {0.068785179350543443f, 0.086864984806094198f, 0.258126381524333814f},
    {0.073122503378666062f, 0.089062672789157360f, 0.271007960104136247f},
    {0.077569356015502078f, 0.091194868066454576f, 0.283940511028086595f},
    {0.082123606798360296f, 0.093264461980209615f, 0.296907101800125139f},
    {0.086783125264549538f, 0.095274345872646299f, 0.309890799924192717f},
    {0.091545780951378580f, 0.097227411085988300f, 0.322874672904229665f},
    {0.096409443396156230f, 0.099126548962459454f, 0.335841788244176764f},
    {0.101371982136191294f, 0.100974650844283476f, 0.348775213447974630f},
    {0.106431266708792591f, 0.102774608073684173f, 0.361658016019563544f},
    {0.111585166651268983f, 0.104529311992885315f, 0.374473263462884509f},
    {0.116831551500929137f, 0.106241653944110601f, 0.387204023281877807f},
    {0.122168290795081957f, 0.107914525269583866f, 0.399833362980484108f},
    {0.127593254071036194f, 0.109550817311528825f, 0.412344350062644083f},
    {0.133104310866100722f, 0.111153421412169287f, 0.424720052032298234f},
    {0.138699330717584335f, 0.112725228913728978f, 0.436943536393387122f},
    {0.144376183162795740f, 0.114269131158431680f, 0.448997870649851416f},
    {0.150132737739043842f, 0.115788019488501176f, 0.460866122305631454f},
    {0.155966863983637405f, 0.117284785246161177f, 0.472531358864668238f},
    {0.161876431433885276f, 0.118762319773635494f, 0.483976647830902162f},
    {0.167859309627096193f, 0.120223514413147881f, 0.495185056708273674f},
    {0.173913368100579030f, 0.121671260506922105f, 0.506139653000723388f},
    {0.180036476391642553f, 0.123108449397181921f, 0.516823504212192142f},
    {0.186226504037595608f, 0.124537972426151111f, 0.527219677846620383f},
    {0.192481320575746878f, 0.125962720936053402f, 0.537311241407948503f},
    {0.198798795543405293f, 0.127385586269112561f, 0.547081262400117341f},
    {0.205176798477879646f, 0.128809459767552426f, 0.556512808327067288f},
    {0.211613198916478701f, 0.130237232773596695f, 0.565588946692739181f},
    {0.218105866396511278f, 0.131671796629469151f, 0.574292745001073301f},
    {0.224652670455286169f, 0.133116042677393548f, 0.582607270756010376f},
    {0.231251480630112249f, 0.134572862259593667f, 0.590515591461491129f},
    {0.237900166458298257f, 0.136045146718293264f, 0.598000774621456177f},
    {0.244596597477152955f, 0.137535787395716091f, 0.605045887739845800f},
    {0.251338643223985247f, 0.139047675634085932f, 0.611633998320600503f},
    {0.258124173236103871f, 0.140583702775626512f, 0.617748173867661232f},
    {0.264951057050817673f, 0.142146760162561697f, 0.623371481884968492f},
    {0.271817164205435391f, 0.143739739137115102f, 0.628486989876462898f},
    {0.278720364237265816f, 0.145365531041510621f, 0.633077765346084731f},
    {0.285658526683618019f, 0.147027027217971978f, 0.637126875797774939f},
    {0.292629521081800570f, 0.148727119008722902f, 0.640617388735474025f},
    {0.299631250257601567f, 0.150468676356250358f, 0.643532446013490134f},
    {0.306665644942835491f, 0.152251979834881895f, 0.645864185880634212f},
    {0.313742458662010115f, 0.154072281080784690f, 0.647622218922145776f},
    {0.320872343728581422f, 0.155924253937230695f, 0.648818163183195851f},
    {0.328065952456005450f, 0.157802572247491890f, 0.649463636708954239f},
    {0.335333937157738127f, 0.159701909854840368f, 0.649570257544591967f},
    {0.342686950147235547f, 0.161616940602548054f, 0.649149643735278947f},
    {0.350135643737953528f, 0.163542338333886983f, 0.648213413326185539f},
    {0.357690670243348108f, 0.165472776892129220f, 0.646773184362482545f},
    {0.365362681976875325f, 0.167402930120546717f, 0.644840574889339879f},
    {0.373162331251990997f, 0.169327471862411510f, 0.642427202951928344f},
    {0.381100270382151385f, 0.171241075960995692f, 0.639544686595418077f},
    {0.389187151680812027f, 0.173138416259571132f, 0.636204643864979436f},
    {0.397433627461429295f, 0.175014166601409921f, 0.632418692805783222f},
    {0.405850350037459007f, 0.176863000829784067f, 0.628198451462999019f},
    {0.414447971722357034f, 0.178679592787965552f, 0.623555537881798183f},
    {0.423237144829579581f, 0.180458616319226411f, 0.618501570107350518f},
    {0.432228521672582522f, 0.182194745266838681f, 0.613048166184826493f},
    {0.441432754564821672f, 0.183882653474074287f, 0.607206944159396689f},
    {0.450860495819753293f, 0.185517014784205458f, 0.600989522076231020f},
    {0.460522397750833201f, 0.187092503040503927f, 0.594407517980500510f},
    {0.470429112671517269f, 0.188603792086241867f, 0.587472549917375075f},
    {0.480591292895261812f, 0.190045555764691287f, 0.580196235932025295f},
    {0.491019590735522427f, 0.191412467919124113f, 0.572590194069621528f},
    {0.501724658505755094f, 0.192699202392812435f, 0.564666042375334243f},
    {0.512717148519416188f, 0.193900433029028235f, 0.556435398894333688f},
    {0.524007713089961191f, 0.195010833671043576f, 0.547909881671790444f},
    {0.535607004530846642f, 0.196025078162130412f, 0.539101108752874536f},
    {0.547525675155527858f, 0.196937840345560777f, 0.530020698182756766f},
    {0.559774377277461266f, 0.197743794064606682f, 0.520680268006607383f},
    {0.572363763210102849f, 0.198437613162540133f, 0.511091436269596633f},
    {0.585304485266908370f, 0.199013971482633140f, 0.501265821016895208f},
    {0.598606746366859843f, 0.199467751515592068f, 0.491215079800879584f},
    {0.612260393523694768f, 0.199803286708129718f, 0.480952659704058594f},
    {0.626227028476252112f, 0.200038024384590229f, 0.470494490910029983f},
    {0.640466172433399539f, 0.200190377829661786f, 0.459856686506125822f},
    {0.654937346604003934f, 0.200278760328032518f, 0.449055359579678459f},
    {0.669600072196932294f, 0.200321585164390609f, 0.438106623218019686f},
    {0.684413870421053172f, 0.200337265623424354f, 0.427026590508481629f},
    {0.699338262485232454f, 0.200344214989821801f, 0.415831374538396359f},
    {0.714332769598338024f, 0.200360846548271188f, 0.404537088395095834f},
    {0.729356912969237436f, 0.200405573583460783f, 0.393159845165912236f},
    {0.744370213806797576f, 0.200496809380078606f, 0.381715757938177358f},
    {0.759332193319885884f, 0.200652967222812950f, 0.370220939799223048f},
    {0.774202372717369802f, 0.200892460396352057f, 0.358691503836382042f},
    {0.788940273208116438f, 0.201233702185383972f, 0.347143563136985855f},
    {0.803505416000993233f, 0.201695105874596964f, 0.335593230788366337f},
    {0.817857322304867296f, 0.202295084748679188f, 0.324056619877856056f},
    {0.831955513328605956f, 0.203052052092318858f, 0.312549843492786861f},
    {0.845759510281076543f, 0.203984421190204129f, 0.301089014720490489f},
    {0.859228834371146388f, 0.205110605327023160f, 0.289690246648299510f},
    {0.872323006807683043f, 0.206449017787464217f, 0.278369652363545272f},
    {0.885001548799553173f, 0.208018071856215431f, 0.267143344953560458f},
    {0.897223981555624661f, 0.209836180817964985f, 0.256027437505676636f},
    {0.908949826284764728f, 0.211921757957401119f, 0.245038043107226045f},
    {0.920138604195840371f, 0.214293216559211908f, 0.234191274845540809f},
    {0.930749836497718919f, 0.216968969908085618f, 0.223503245807952777f},
    {0.940743044399267925f, 0.219967431288710435f, 0.212990069081794103f},
    {0.950077749109354275f, 0.223307013985774461f, 0.202667857754396746f},
    {0.958713471836846076f, 0.227006131283966045f, 0.192552724913092665f},
    {0.966609733790609882f, 0.231083196467973234f, 0.182660783645214014f},
    {0.973726056179512911f, 0.235556622822484185f, 0.173008147038092863f},
    {0.980021960212423271f, 0.240444823632187304f, 0.163610928179061088f},
    {0.985456967098207404f, 0.245766212181770499f, 0.154485240155450898f},
    {0.989992310024681244f, 0.251538345766447957f, 0.145646797324454569f},
    {0.993628597695470517f, 0.257759093923528526f, 0.137102143250052183f},
    {0.996405814330012518f, 0.264406638432415575f, 0.128848650703011575f},
    {0.998365656126691259f, 0.271458305083038642f, 0.120883293723960977f},
    {0.999549819283892527f, 0.278891419665327323f, 0.113203046353528458f},
    {1.000000000000000000f, 0.286683307969210988f, 0.105804882632342043f},
    {0.999757894473399245f, 0.294811295784618732f, 0.098685776601030284f},
    {0.998865198902474716f, 0.303252708901480372f, 0.091842702300221152f},
    {0.997363609485611313f, 0.311984873109725003f, 0.085272633770542783f},
    {0.995294822421193826f, 0.320985114199282329f, 0.078972545052623383f},
    {0.992700533907607152f, 0.330230757960081611f, 0.072939410187091089f},
    {0.989622440143236193f, 0.339699130182052444f, 0.067170203214574078f},
    {0.986102237326465625f, 0.349367556655124256f, 0.061661898175700343f},
    {0.982181621655680459f, 0.359213363169226196f, 0.056411469111098379f},
    {0.977902289329265151f, 0.369213875514287804f, 0.051415890061396213f},
    {0.973305936545604933f, 0.379346419480238561f, 0.046672135067221961f},
    {0.968434259503084149f, 0.389588320857007842f, 0.042177178169203841f},
    {0.963328954400087811f, 0.399916905434525349f, 0.037927993407969977f},
    {0.958031717435000929f, 0.410309499002720124f, 0.033921554824148548f},
    {0.952584244806208180f, 0.420743427351521648f, 0.030154836458367723f},
    {0.947028232712094353f, 0.431196016270859517f, 0.026624812351255661f},
    {0.941405377351044126f, 0.441644591550663268f, 0.023328456543440464f},
    {0.935757374921442842f, 0.452066478980862052f, 0.020262743075550451f},
    {0.930125921621674623f, 0.462439004351385297f, 0.017424645988213697f},
    {0.924552713650124702f, 0.472739493452162374f, 0.014811139322058376f},
    {0.919079447205177869f, 0.482945272073123100f, 0.012419197117712661f},
    {0.913747818485218688f, 0.493033666004196403f, 0.010245793415804689f},
    {0.908599523688632282f, 0.502982001035312098f, 0.008287902256962654f},
    {0.903676259013803107f, 0.512767602956399782f, 0.006542497681814660f},
    {0.899019720659116617f, 0.522367797557388269f, 0.005006553730988977f},
    {0.894671604822957156f, 0.531759910628207266f, 0.003677044445113718f},
    {0.890673607703709513f, 0.540921267958786034f, 0.002550943864817048f},
    {0.887065047751219193f, 0.549830458517965859f, 0.001625557543744623f},
    {0.883852963101162681f, 0.558483220191489771f, 0.000902691656267632f},
    {0.881021127997507980f, 0.566887649807571448f, 0.000387395900120439f},
    {0.878552803090538403f, 0.575052117041068955f, 0.000084791579849176f},
    {0.876431249030537263f, 0.582984991566840471f, 0.000000000000000000f},
    {0.874639726467788092f, 0.590694643059744617f, 0.000138142465119049f},
    {0.873161496052574426f, 0.598189441194639127f, 0.000504340279752461f},
    {0.871979818435180021f, 0.605477755646382731f, 0.001103714748446380f},
    {0.871077954265888188f, 0.612567956089833499f, 0.001941387175746942f},
    {0.870439164194981907f, 0.619468412199849494f, 0.003022478866200286f},
    {0.870046708872745378f, 0.626187493651289451f, 0.004352111124352565f},
    {0.869883848949461691f, 0.632733570119011435f, 0.005935405254749913f},
    {0.869933845075414380f, 0.639115011277873513f, 0.007777482561938525f},
    {0.870179957900886647f, 0.645340186802734306f, 0.009883464350464452f},
    {0.870605448076162358f, 0.651417466368451548f, 0.012258471924873861f},
    {0.871193576251524715f, 0.657355219649884082f, 0.014907626589712918f},
    {0.871927603077257363f, 0.663161816321889863f, 0.017836049649527747f},
    {0.872790789203643724f, 0.668845626059327181f, 0.021048862408864503f},
    {0.873766395280967445f, 0.674415018537054434f, 0.024551186172269316f},
    {0.874837681959511504f, 0.679878363429929800f, 0.028348142244288332f},
    {0.875987909889559657f, 0.685244030412811345f, 0.032444851929467694f},
    {0.877200339721395550f, 0.690520389160557913f, 0.036846436532353671f},
    {0.878458232105302605f, 0.695715809348027125f, 0.041558017357492164f},
    {0.879744847691563914f, 0.700838660650077494f, 0.046584715709429424f},
    {0.881043447130463120f, 0.705897312741567307f, 0.051931652892711573f},
    {0.882337291072284091f, 0.710900135297354963f, 0.057603950211884816f},
    {0.883609640167309585f, 0.715855497992298417f, 0.063606728971495219f},
    {0.884843755065823689f, 0.720771770501256182f, 0.069945110476088965f},
    {0.886022896418109607f, 0.725657322499086543f, 0.076624216030212397f},
    {0.887130324874450871f, 0.730520523660647680f, 0.083649166938411262f},
    {0.888149301085130793f, 0.735369743660797548f, 0.091025084505231876f},
    {0.889063085700433020f, 0.740213352174394768f, 0.098757090035220402f},
    {0.889856608550115724f, 0.745059012684981758f, 0.106849359129167404f},
    {0.890529327507511459f, 0.749908242196125951f, 0.115297836262583553f},
    {0.891088180842858346f, 0.754759392928089801f, 0.124094227757111958f},
    {0.891540168647855791f, 0.759610790945901893f, 0.133230204908330707f},
    {0.891892291014203309f, 0.764460762314590259f, 0.142697439011817973f},
    {0.892151548033601194f, 0.769307633099183930f, 0.152487601363152064f},
    {0.892324939797748296f, 0.774149729364710271f, 0.162592363257910544f},
    {0.892419466398344463f, 0.778985377176197979f, 0.173003395991671888f},
    {0.892442127927089546f, 0.783812902598675754f, 0.183712370860013990f},
    {0.892399924475682838f, 0.788630631697171403f, 0.194710959158515134f},
    {0.892299856135824632f, 0.793436890536713957f, 0.205990832182753325f},
    {0.892148922999213778f, 0.798230005182331115f, 0.217543661228306734f},
    {0.891954125157550237f, 0.803008301699051463f, 0.229361117590753755f},
    {0.891722462702534080f, 0.807770106151903589f, 0.241434872565671921f},
    {0.891460935725864267f, 0.812513744605915411f, 0.253756597448639543f},
    {0.891176544319240982f, 0.817237543126115518f, 0.266317963535234681f},
    {0.890876288574363406f, 0.821939827777532384f, 0.279110642121035646f},
    {0.890567168582931390f, 0.826618924625194040f, 0.292126304501620360f},
    {0.890256184436644671f, 0.831273159734128853f, 0.305356621972567188f},
    {0.889950336227202765f, 0.835900859169365407f, 0.318793265829453720f},
    {0.889656624046305522f, 0.840500348995932178f, 0.332427907367858488f},
    {0.889382047985652124f, 0.845069955278856977f, 0.346252217883360025f},
    {0.889133608136942644f, 0.849608004083168611f, 0.360257868671535419f},
    {0.888918304591876596f, 0.854112821473895223f, 0.374436531027963093f},
    {0.888743137442153497f, 0.858582733516065177f, 0.388779876248221468f},
    {0.888615106779473085f, 0.863016066274706839f, 0.403279575627888520f},
    {0.888541212695535099f, 0.867411145814848461f, 0.417927300462542117f},
    {0.888528455282039054f, 0.871766298201518741f, 0.432714722047760791f},
    {0.888583834630684355f, 0.876079849499745600f, 0.447633511679122575f},
    {0.888714350833171185f, 0.880350125774557624f, 0.462675340652205114f},
    {0.888927003981198949f, 0.884575453090982955f, 0.477831880262586883f},
    {0.889228794166467162f, 0.888754157514050291f, 0.493094801805845862f},
    {0.889626721480675453f, 0.892884565108787776f, 0.508455776577560248f},
    {0.890127786015523670f, 0.896965001940223661f, 0.523906475873308075f},
    {0.890738987862711218f, 0.900993794073385978f, 0.539438570988667432f},
    {0.891467327113938057f, 0.904969267573304093f, 0.555043733219216406f},
    {0.892319803860903593f, 0.908889748505005590f, 0.570713633860533309f},
    {0.893303418195307453f, 0.912753562933519169f, 0.586439944208196451f},
    {0.894425170208849263f, 0.916559036923872639f, 0.602214335557783031f},
    {0.895692059993228762f, 0.920304496541094808f, 0.618028479204871917f},
    {0.897111087640145466f, 0.923988267850213707f, 0.633874046445040862f},
    {0.898689253241299224f, 0.927608676916258035f, 0.649742708573868066f},
    {0.900433556888389441f, 0.931164049804255822f, 0.665626136886931730f},
    {0.902350998673116078f, 0.934652712579235656f, 0.681516002679809940f},
    {0.904448578687178539f, 0.938072991306225901f, 0.697403977248081119f},
    {0.906733297022276341f, 0.941423212050254921f, 0.713281731887322579f},
    {0.909212153770109444f, 0.944701700876350636f, 0.729140937893112961f},
    {0.911892149022377252f, 0.947906783849541745f, 0.744973266561030023f},
    {0.914780282870779393f, 0.951036787034856723f, 0.760770389186652185f},
    {0.917883555407015606f, 0.954090036497323379f, 0.776523977065557425f},
    {0.921208966722785516f, 0.957064858301970744f, 0.792225701493324053f},
    {0.924763516909788974f, 0.959959578513826850f, 0.807867233765530046f},
    {0.928554206059725273f, 0.962772523197919949f, 0.823440245177753383f},
    {0.932588034264294152f, 0.965502018419278296f, 0.838936407025572484f},
    {0.936872001615195349f, 0.968146390242930699f, 0.854347390604564993f},
    {0.941413108204128490f, 0.970703964733905189f, 0.869664867210309223f},
    {0.946218354122792982f, 0.973173067957230020f, 0.884880508138383259f},
    {0.951294739462888783f, 0.975552025977933668f, 0.899985984684365303f},
    {0.956649264316115522f, 0.977839164861044607f, 0.914972968143833443f},
    {0.962288928774172492f, 0.980032810671590870f, 0.929833129812365544f},
    {0.968220732928759764f, 0.982131289474601155f, 0.944558140985540362f},
    {0.974451676871576633f, 0.984132927335103491f, 0.959139672958935208f},
    {0.980988760694322948f, 0.986036050318126356f, 0.973569397028128503f},
    {0.987838984488698224f, 0.987838984488698224f, 0.987838984488698224f}
};

// ============================================================================
// Constructor & Destructor
// ============================================================================

ColorTransform::ColorTransform(ColorTheme theme)
    : current_theme_(theme)
{
    generateLUT();
}

// ============================================================================
// Main Processing
// ============================================================================

uint32_t ColorTransform::valueToColor(float normalized_value) const {
    // Clamp to [0, 1]
    float clamped = std::clamp(normalized_value, 0.0f, 1.0f);

    // Convert to index [0, 255]
    size_t idx = static_cast<size_t>(clamped * 255.0f);

    // Lookup and return
    return color_lut_[idx];
}

void ColorTransform::transformColumn(const float* input, size_t height,
                                    uint32_t* output) const {
    // Sequential access for cache efficiency
    for (size_t i = 0; i < height; ++i) {
        float clamped = std::clamp(input[i], 0.0f, 1.0f);
        size_t idx = static_cast<size_t>(clamped * 255.0f);
        output[i] = color_lut_[idx];
    }
}

// ============================================================================
// Configuration Methods
// ============================================================================

void ColorTransform::setTheme(ColorTheme theme) {
    if (theme != current_theme_) {
        current_theme_ = theme;
        generateLUT();
    }
}

float ColorTransform::getLuminance(uint32_t color) {
    // Extract RGB channels
    uint8_t r = color & 0xFF;
    uint8_t g = (color >> 8) & 0xFF;
    uint8_t b = (color >> 16) & 0xFF;

    // Standard RGB luminance formula
    return 0.299f * r + 0.587f * g + 0.114f * b;
}

// ============================================================================
// Private Methods
// ============================================================================

void ColorTransform::generateLUT() {
    switch (current_theme_) {
        case ColorTheme::CMRMAP:
            generateCMRMAP();
            break;
        case ColorTheme::Grayscale:
            generateGrayscale();
            break;
        default:
            generateGrayscale(); // Fallback to grayscale
            break;
    }
}

void ColorTransform::generateCMRMAP() {
    // Convert Python RGB [0,1] data to RGBA uint32_t
    for (size_t i = 0; i < 256; ++i) {
        float r = CMRMAP_DATA[i][0];
        float g = CMRMAP_DATA[i][1];
        float b = CMRMAP_DATA[i][2];
        color_lut_[i] = toRGBA(r, g, b);
    }
}

void ColorTransform::generateGrayscale() {
    // Simple linear grayscale: 0.0 → Black (0,0,0), 1.0 → White (255,255,255)
    for (size_t i = 0; i < 256; ++i) {
        float t = static_cast<float>(i) / 255.0f;
        color_lut_[i] = toRGBA(t, t, t);
    }
}

uint32_t ColorTransform::toRGBA(float r, float g, float b) {
    // Clamp to [0, 1] and convert to [0, 255]
    uint8_t r8 = static_cast<uint8_t>(std::clamp(r * 255.0f, 0.0f, 255.0f));
    uint8_t g8 = static_cast<uint8_t>(std::clamp(g * 255.0f, 0.0f, 255.0f));
    uint8_t b8 = static_cast<uint8_t>(std::clamp(b * 255.0f, 0.0f, 255.0f));

    // Pack into RGBA format: 0xAABBGGRR (little-endian)
    // Alpha channel is always 0xFF (opaque)
    return 0xFF000000 | (b8 << 16) | (g8 << 8) | r8;
}

} // namespace friture
